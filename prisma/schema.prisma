generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  RECEPTIONIST
  DENTIST
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELLED
}

enum Weekday {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

model User {
  id       Int      @id @default(autoincrement())
  name     String
  email    String   @unique
  password String
  role     UserRole
  dentist  Dentist? @relation("DentistUser")

  createdAppointments Appointment[] @relation("CreatedBy")
  updatedAppointments Appointment[] @relation("UpdatedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Dentist {
  userId    Int     @unique
  user      User    @relation("DentistUser", fields: [userId], references: [id], onDelete: Cascade)
  specialty String?

  availabilities Availability[]
  scheduleLocks  ScheduleLock[]
  appointments   Appointment[]
  services       DentistService[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dentists")
}

model Patient {
  id        Int       @id @default(autoincrement())
  name      String
  phone     String
  email     String?
  birthDate DateTime?
  address   String?
  notes     String?

  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@map("patients")
}

model Service {
  id       Int      @id @default(autoincrement())
  name     String
  duration Int
  price    Decimal @db.Decimal(10, 2)

  dentists     DentistService[]
  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("services")
}

model DentistService {
  dentistId Int
  serviceId Int

  dentist Dentist @relation(fields: [dentistId], references: [userId])
  service Service @relation(fields: [serviceId], references: [id])

  @@id([dentistId, serviceId])
  @@map("dentist_services")
}

model Appointment {
  id            Int               @id @default(autoincrement())
  startDateTime DateTime
  endDateTime   DateTime
  agreedPrice Decimal @db.Decimal(10, 2)
  status        AppointmentStatus @default(SCHEDULED)

  patientId Int
  patient   Patient @relation(fields: [patientId], references: [id])
  dentistId Int
  dentist   Dentist @relation(fields: [dentistId], references: [userId])
  serviceId Int
  service   Service @relation(fields: [serviceId], references: [id])

  createdById Int
  createdBy   User  @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById Int?
  updatedBy   User? @relation("UpdatedBy", fields: [updatedById], references: [id])

  originalAppointmentId Int?
  originalAppointment   Appointment?  @relation("RescheduleChain", fields: [originalAppointmentId], references: [id])
  rescheduledFrom       Appointment[] @relation("RescheduleChain")

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dentistId, startDateTime])
  @@index([patientId])
  @@map("appointments")
}

model Availability {
  id        Int     @id @default(autoincrement())
  weekday   Weekday
  startTime Int
  endTime   Int
  dentistId Int
  dentist   Dentist @relation(fields: [dentistId], references: [userId], onDelete: Cascade)

  @@unique([dentistId, weekday, startTime])
  @@map("availabilities")
}

model ScheduleLock {
  id        Int      @id @default(autoincrement())
  startDate DateTime
  endDate   DateTime
  reason    String?
  dentistId Int
  dentist   Dentist  @relation(fields: [dentistId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("schedule_locks")
}
